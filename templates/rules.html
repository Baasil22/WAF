{% extends "base.html" %}

{% block title %}Rule Management - WAFGuard{% endblock %}
{% block page_title %}Rule Management{% endblock %}
{% block page_subtitle %}Manage IP blacklist, whitelist, and rate limiting{% endblock %}

{% block content %}
<div class="rules-container">
    <div class="rules-grid">
        <!-- IP Blacklist -->
        <div class="rule-card">
            <div class="card-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" stroke="currentColor" stroke-width="2" />
                    </svg>
                    IP Blacklist
                </h3>
                <span class="badge danger">{{ ip_lists.blacklist|length }} blocked</span>
            </div>

            <div class="add-ip-form">
                <input type="text" id="blacklist-ip-input" placeholder="Enter IP address (e.g., 192.168.1.1)" />
                <button class="btn-primary btn-sm" onclick="addToBlacklist()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                    Add
                </button>
            </div>

            <div class="ip-list">
                {% if ip_lists.blacklist %}
                {% for ip in ip_lists.blacklist %}
                <div class="ip-item">
                    <span class="ip-address">{{ ip }}</span>
                    <span class="ip-badge danger">Blocked</span>
                    <button class="btn-danger btn-sm" onclick="removeFromBlacklist('{{ ip }}')"
                        title="Remove from blacklist">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                            style="width:14px;height:14px;">
                            <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Remove
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-list">
                    <svg viewBox="0 0 24 24" fill="none" style="width:32px;height:32px;opacity:0.5;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                        <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <span>No IPs blacklisted</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- IP Whitelist -->
        <div class="rule-card">
            <div class="card-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                        <polyline points="22 4 12 14.01 9 11.01" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    IP Whitelist
                </h3>
                <span class="badge success">{{ ip_lists.whitelist|length }} allowed</span>
            </div>

            <div class="add-ip-form">
                <input type="text" id="whitelist-ip-input" placeholder="Enter IP address (e.g., 10.0.0.1)" />
                <button class="btn-primary btn-sm" onclick="addToWhitelist()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                        <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                    </svg>
                    Add
                </button>
            </div>

            <div class="ip-list">
                {% if ip_lists.whitelist %}
                {% for ip in ip_lists.whitelist %}
                <div class="ip-item">
                    <span class="ip-address">{{ ip }}</span>
                    <span class="ip-badge success">Allowed</span>
                    <button class="btn-secondary btn-sm" onclick="removeFromWhitelist('{{ ip }}')"
                        title="Remove from whitelist">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                            style="width:14px;height:14px;">
                            <polyline points="3 6 5 6 21 6" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Remove
                    </button>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-list">
                    <svg viewBox="0 0 24 24" fill="none" style="width:32px;height:32px;opacity:0.5;">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                        <path d="M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                    <span>No IPs whitelisted</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Rate Limiting Status -->
        <div class="rule-card full-width">
            <div class="card-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Rate Limiting Status
                </h3>
            </div>

            <div class="rate-limit-info">
                <div class="rate-stat">
                    <span class="rate-value">{{ rate_stats.max_requests }}</span>
                    <span class="rate-label">Max Requests</span>
                </div>
                <div class="rate-stat">
                    <span class="rate-value">{{ rate_stats.window_seconds }}s</span>
                    <span class="rate-label">Time Window</span>
                </div>
                <div class="rate-stat">
                    <span class="rate-value">{{ rate_stats.ban_duration }}s</span>
                    <span class="rate-label">Ban Duration</span>
                </div>
            </div>

            {% if rate_stats.banned_ips %}
            <div class="banned-section">
                <h4>Currently Rate-Limited IPs</h4>
                <div class="ip-list">
                    {% for ip, info in rate_stats.banned_ips.items() %}
                    <div class="ip-item">
                        <span class="ip-address">{{ ip }}</span>
                        <span class="ip-badge warning">Rate Limited</span>
                        <button class="btn-secondary btn-sm" onclick="unbanIP('{{ ip }}')">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                                style="width:14px;height:14px;">
                                <path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            Unban
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="empty-list" style="margin-top: 20px;">
                <svg viewBox="0 0 24 24" fill="none" style="width:32px;height:32px;color:var(--success);">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" />
                    <polyline points="22 4 12 14.01 9 11.01" stroke="currentColor" stroke-width="2" />
                </svg>
                <span>No IPs are currently rate-limited</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .rules-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
    }

    .rule-card.full-width {
        grid-column: 1 / -1;
    }

    .add-ip-form {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
    }

    .add-ip-form input {
        flex: 1;
        padding: 12px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
    }

    .add-ip-form input:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }

    .add-ip-form .btn-primary {
        display: flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .add-ip-form .btn-primary svg {
        width: 16px;
        height: 16px;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge.danger {
        background: rgba(255, 71, 87, 0.1);
        color: var(--danger);
    }

    .badge.success {
        background: rgba(0, 200, 83, 0.1);
        color: var(--success);
    }

    .ip-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .ip-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border-radius: 10px;
    }

    .ip-address {
        font-family: 'SF Mono', 'Consolas', monospace;
        flex: 1;
        font-size: 14px;
    }

    .ip-badge {
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }

    .ip-badge.danger {
        background: rgba(255, 71, 87, 0.1);
        color: var(--danger);
    }

    .ip-badge.success {
        background: rgba(0, 200, 83, 0.1);
        color: var(--success);
    }

    .ip-badge.warning {
        background: rgba(255, 193, 7, 0.1);
        color: var(--warning);
    }

    .empty-list {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
        font-size: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .rate-limit-info {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }

    .rate-stat {
        text-align: center;
        padding: 20px;
        background: var(--bg-tertiary);
        border-radius: 12px;
    }

    .rate-value {
        display: block;
        font-size: 28px;
        font-weight: 700;
        color: var(--accent-primary);
    }

    .rate-label {
        display: block;
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .banned-section {
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .banned-section h4 {
        margin-bottom: 12px;
        color: var(--text-secondary);
        font-size: 14px;
    }

    .btn-sm {
        padding: 8px 14px !important;
        font-size: 12px !important;
    }

    @media (max-width: 768px) {
        .rules-grid {
            grid-template-columns: 1fr;
        }

        .rate-limit-info {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}