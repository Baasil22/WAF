{% extends "base.html" %}

{% block title %}Dashboard - WAFGuard{% endblock %}
{% block page_title %}Security Dashboard{% endblock %}
{% block page_subtitle %}Real-time threat monitoring and analytics{% endblock %}

{% block content %}
<div class="dashboard-grid">
    <!-- Stats Cards -->
    <div class="stats-row">
        <div class="stat-card primary">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 12H18L15 21L9 3L6 12H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value" id="total-requests">{{ stats.total_requests }}</span>
                <span class="stat-label">Total Requests</span>
            </div>
            <div class="stat-trend up">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 6L13.5 15.5L8.5 10.5L1 18" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M17 6H23V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
        </div>

        <div class="stat-card danger">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 8v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <circle cx="12" cy="16" r="1" fill="currentColor" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value" id="blocked-requests">{{ stats.blocked_requests }}</span>
                <span class="stat-label">Blocked Attacks</span>
            </div>
            <div class="stat-percentage">
                <span id="block-rate">{{ "%.1f"|format(stats.block_rate if stats.block_rate else 0) }}%</span>
            </div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                    <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value" id="uptime">{{ stats.uptime_formatted }}</span>
                <span class="stat-label">Uptime</span>
            </div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">Active</span>
                <span class="stat-label">Protection Status</span>
            </div>
        </div>
    </div>

    <!-- Attack Types Chart -->
    <div class="chart-section">
        <div class="chart-card">
            <div class="card-header">
                <h3>Attack Distribution</h3>
                <div class="card-actions">
                    <button class="btn-icon" onclick="refreshStats()">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M23 4V10H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M1 20V14H7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path
                                d="M3.51 9C4.01717 7.56678 4.87913 6.28531 6.01547 5.27542C7.1518 4.26553 8.52547 3.55976 10.0083 3.22426C11.4911 2.88875 13.0348 2.93434 14.4952 3.35677C15.9556 3.77921 17.2853 4.56471 18.36 5.64L23 10M1 14L5.64 18.36C6.71475 19.4353 8.04437 20.2208 9.50481 20.6432C10.9652 21.0657 12.5089 21.1112 13.9917 20.7757C15.4745 20.4402 16.8482 19.7345 17.9845 18.7246C19.1209 17.7147 19.9828 16.4332 20.49 15"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="attack-types-grid">
                <div class="attack-type-card sql">
                    <div class="attack-type-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <ellipse cx="12" cy="5" rx="9" ry="3" stroke="currentColor" stroke-width="2" />
                            <path d="M21 12C21 13.66 16.97 15 12 15C7.03 15 3 13.66 3 12" stroke="currentColor"
                                stroke-width="2" />
                            <path d="M3 5V19C3 20.66 7.03 22 12 22C16.97 22 21 20.66 21 19V5" stroke="currentColor"
                                stroke-width="2" />
                        </svg>
                    </div>
                    <div class="attack-type-info">
                        <span class="attack-type-count" id="sql-blocked">{{ stats.sql_injection_blocked }}</span>
                        <span class="attack-type-name">SQL Injection</span>
                    </div>
                    <div class="attack-type-bar">
                        <div class="bar-fill" id="sql-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="attack-type-card xss">
                    <div class="attack-type-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="16,18 22,12 16,6" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <polyline points="8,6 2,12 8,18" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div class="attack-type-info">
                        <span class="attack-type-count" id="xss-blocked">{{ stats.xss_blocked }}</span>
                        <span class="attack-type-name">XSS Attacks</span>
                    </div>
                    <div class="attack-type-bar">
                        <div class="bar-fill" id="xss-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="attack-type-card path">
                    <div class="attack-type-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div class="attack-type-info">
                        <span class="attack-type-count" id="path-blocked">{{ stats.path_traversal_blocked }}</span>
                        <span class="attack-type-name">Path Traversal</span>
                    </div>
                    <div class="attack-type-bar">
                        <div class="bar-fill" id="path-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="attack-type-card cmd">
                    <div class="attack-type-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="4" width="20" height="16" rx="2" stroke="currentColor" stroke-width="2" />
                            <path d="M6 9L9 12L6 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <path d="M12 15H18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </div>
                    <div class="attack-type-info">
                        <span class="attack-type-count" id="cmd-blocked">{{ stats.command_injection_blocked }}</span>
                        <span class="attack-type-name">Command Injection</span>
                    </div>
                    <div class="attack-type-bar">
                        <div class="bar-fill" id="cmd-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="attack-type-card rate">
                    <div class="attack-type-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div class="attack-type-info">
                        <span class="attack-type-count" id="rate-blocked">{{ stats.rate_limited }}</span>
                        <span class="attack-type-name">Rate Limited</span>
                    </div>
                    <div class="attack-type-bar">
                        <div class="bar-fill" id="rate-bar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="attack-type-card ip">
                    <div class="attack-type-icon">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                            <line x1="2" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2" />
                            <path
                                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                                stroke="currentColor" stroke-width="2" />
                        </svg>
                    </div>
                    <div class="attack-type-info">
                        <span class="attack-type-count" id="ip-blocked">{{ stats.ip_blocked }}</span>
                        <span class="attack-type-name">IP Blocked</span>
                    </div>
                    <div class="attack-type-bar">
                        <div class="bar-fill" id="ip-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Attacks -->
        <div class="chart-card">
            <div class="card-header">
                <h3>Recent Attacks</h3>
                <a href="{{ url_for('logs_page') }}" class="btn-link">View All</a>
            </div>
            <div class="recent-attacks" id="recent-attacks">
                <div class="loading-placeholder">
                    <div class="spinner"></div>
                    <span>Loading attack logs...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-section">
        <div class="chart-card">
            <div class="card-header">
                <h3>Quick Actions</h3>
            </div>
            <div class="quick-actions">
                <button class="action-btn" onclick="showBlockIPModal()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" stroke="currentColor" stroke-width="2" />
                    </svg>
                    <span>Block IP</span>
                </button>
                <button class="action-btn" onclick="showWhitelistIPModal()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Whitelist IP</span>
                </button>
                <button class="action-btn" onclick="clearLogs()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="3,6 5,6 21,6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M19 6V20C19 21.1046 18.1046 22 17 22H7C5.89543 22 5 21.1046 5 20V6"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M8 6V4C8 2.89543 8.89543 2 10 2H14C15.1046 2 16 2.89543 16 4V6" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Clear Logs</span>
                </button>
                <button class="action-btn" onclick="resetStats()">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M23 4V10H17" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path
                            d="M20.49 15C19.9828 16.4332 19.1209 17.7147 17.9845 18.7246C16.8482 19.7345 15.4745 20.4402 13.9917 20.7757C12.5089 21.1112 10.9652 21.0657 9.50481 20.6432C8.04437 20.2208 6.71475 19.4353 5.64 18.36L1 14M23 10L20.49 15M1 20V14H7M3.51 9C4.01717 7.56678 4.87913 6.28531 6.01547 5.27542C7.1518 4.26553 8.52547 3.55976 10.0083 3.22426C11.4911 2.88875 13.0348 2.93434 14.4952 3.35677C15.9556 3.77921 17.2853 4.56471 18.36 5.64L23 10"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span>Reset Stats</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for blocking IP -->
<div class="modal" id="ipModal">
    <div class="modal-overlay" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Block IP Address</h3>
            <button class="modal-close" onclick="closeModal()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="ipInput">IP Address or CIDR Range</label>
                <input type="text" id="ipInput" placeholder="e.g., 192.168.1.1 or 192.168.0.0/24">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn-primary" id="modalAction">Block IP</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function () {
        refreshStats();
        loadRecentAttacks();
        updateAttackBars();

        // Auto-refresh every 5 seconds
        setInterval(function () {
            refreshStats();
            loadRecentAttacks();
        }, 5000);
    });
</script>
{% endblock %}